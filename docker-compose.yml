version: "3.9"

services:

  auth-service:
    build:
      context: .
      dockerfile: EstateHub.BackEnd/EstateHub.Authorization.API/Dockerfile
      args:
        BUILD_CONFIGURATION: Release
    container_name: estatehub-auth-service
    ports:
      - "${AUTH_HTTP_PORT}:8080"
      - "${AUTH_GRPC_PORT}:8082"
    environment:
      - ConnectionStrings__DefaultConnection=Server=db;Database=EstateHubAuthDB;User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True;Encrypt=False;MultipleActiveResultSets=True;
      - JWT__Secret=${JWT_SECRET}
      - JWT__Issuer=${JWT_ISSUER:-https://api.estatehub.com}
      - JWT__Audience=${JWT_AUDIENCE:-https://app.estatehub.com}
      - JWT__ExpirationMinutes=10
      - Smtp__User=${SMTP_USER}
      - Smtp__Password=${SMTP_PASSWORD}
      - Smtp__Host=${SMTP_HOST}
      - Smtp__Port=${SMTP_PORT}
      - Cors__AllowedOrigins__0=${CORS_ORIGIN_1:-https://estatehub.com}
      - Cors__AllowedOrigins__1=${CORS_ORIGIN_2:-https://www.estatehub.com}
      - Cors__AllowedOrigins__2=${CORS_ORIGIN_3:-https://app.estatehub.com}
      - Cors__AllowLocalhost=true
      - ASPNETCORE_ENVIRONMENT=${ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:8080;http://+:8082
      - Kestrel__Endpoints__Http__Url=http://+:8080
      - Kestrel__Endpoints__gRPC__Url=http://+:8082
      - Kestrel__Endpoints__gRPC__Protocols=Http2
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED=true
      - ASPNETCORE_FORWARDEDHEADERS__FORWARDEDHEADERS=All
      - ASPNETCORE_FORWARDEDHEADERS__KNOWNNETWORKS__0__PREFIX=0.0.0.0
      - ASPNETCORE_FORWARDEDHEADERS__KNOWNNETWORKS__0__PREFIXLENGTH=0
      - EnforceHttpsRedirect=false
    depends_on:
      - db
      - mailhog
    networks:
      - estatehub-network
    restart: unless-stopped

  listing-service:
    build:
      context: .
      dockerfile: EstateHub.BackEnd/EstateHub.ListingService.API/Dockerfile
      args:
        BUILD_CONFIGURATION: Release
    container_name: estatehub-listing-service
    ports:
      - "${LISTING_HTTP_PORT}:8080"
    environment:
      - ConnectionStrings__DefaultConnection=Server=db;Database=estatehub-listing;User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=True;Encrypt=False;MultipleActiveResultSets=True;
      - JWT__Secret=${JWT_SECRET}
      - JWT__Issuer=${JWT_ISSUER:-https://api.estatehub.com}
      - JWT__Audience=${JWT_AUDIENCE:-https://app.estatehub.com}
      - Auth__Authority=http://auth-service:8080
      - Auth__Audience=estatehub-api
      - Cors__AllowedOrigins__0=${CORS_ORIGIN_1:-https://estatehub.com}
      - Cors__AllowedOrigins__1=${CORS_ORIGIN_2:-https://www.estatehub.com}
      - Cors__AllowedOrigins__2=${CORS_ORIGIN_3:-https://app.estatehub.com}
      - Cors__AllowLocalhost=true
      - ASPNETCORE_ENVIRONMENT=${ENVIRONMENT}
      - ASPNETCORE_URLS=http://+:8080
      - AuthService__GrpcUrl=${AUTH_SERVICE_GRPC_URL:-http://auth-service:8082}
      - MongoDB__ConnectionString=mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@mongodb:27017/?authSource=admin
      - MongoDB__DatabaseName=${MONGO_DATABASE:-estatehub-files}
      - MongoDB__GridFSBucket=${MONGO_GRIDFS_BUCKET:-photos}
      - OpenAI__ApiKey=${OPENAI_API_KEY}
      - OpenAI__Model=${OPENAI_MODEL:-gpt-3.5-turbo}
      - Moderation__Enabled=${MODERATION_ENABLED:-true}
      - Moderation__FailOpen=${MODERATION_FAIL_OPEN:-false}
      - Smtp__Host=${SMTP_HOST:-mailhog}
      - Smtp__Port=${SMTP_PORT:-1025}
      - Smtp__User=${SMTP_USER:-}
      - Smtp__Password=${SMTP_PASSWORD:-}
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED=true
      - ASPNETCORE_FORWARDEDHEADERS__FORWARDEDHEADERS=All
      - ASPNETCORE_FORWARDEDHEADERS__KNOWNNETWORKS__0__PREFIX=0.0.0.0
      - ASPNETCORE_FORWARDEDHEADERS__KNOWNNETWORKS__0__PREFIXLENGTH=0
      - EnforceHttpsRedirect=false
    depends_on:
      - db
      - mongodb
      - mailhog
    networks:
      - estatehub-network
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: EstateHub.Frontend/Dockerfile
      args:
        - VITE_ENVIRONMENT=${VITE_ENVIRONMENT}
        - VITE_ENABLE_DEBUG=${VITE_ENABLE_DEBUG}
        - VITE_LISTING_SERVICE_GRAPHQL_URL=${VITE_LISTING_SERVICE_GRAPHQL_URL}
        - VITE_LISTING_SERVICE_ASSETS_URL=${VITE_LISTING_SERVICE_ASSETS_URL}
        - VITE_AUTHORIZATION_SERVICE_URL=${VITE_AUTHORIZATION_SERVICE_URL}
    container_name: estatehub-frontend
    ports:
      - "${FRONTEND_PORT:-3001}:3001"
    depends_on:
      - auth-service
      - listing-service
    networks:
      - estatehub-network
    restart: unless-stopped

  mongodb:
    image: mongo:7.0
    container_name: estatehub-mongodb
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USERNAME:-mongouser}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-mongopass}
      - MONGO_INITDB_DATABASE=${MONGO_DATABASE:-estatehub-files}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    networks:
      - estatehub-network
    restart: unless-stopped

  mailhog:
    image: mailhog/mailhog:latest
    container_name: estatehub-mailhog
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    networks:
      - estatehub-network
    restart: unless-stopped

  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    # For Mac M1/M2, use linux/amd64 for SQL Server (no native ARM support)
    # For Intel Macs, this also works
    platform: linux/amd64
    container_name: estatehub-db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${DB_PASSWORD}
      - MSSQL_PID=${MSSQL_PID}
    ports:
      - "${DB_PORT}:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - estatehub-network
    restart: unless-stopped

networks:
  estatehub-network:
    driver: bridge

volumes:
  sqlserver-data:
    driver: local
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
